@startuml
title MRP Architecture â€” compact overview (current)

skinparam packageStyle rectangle
skinparam shadowing false

package "Server" {
  class Server
  class Handler
  class Request
  class Response
}

package "Application Core" {
  class MrpApplication {
    +handle(request: Request): Response
  }
  class Router {
    +findController(path): Optional<Controller>
  }
  class RouterCreator
  class ExceptionMapper {
    +toResponse(ex): Response
  }
}

package "Middleware" {
  class AuthMiddleware {
    +authenticate(requestDto: RequestDto): User
  }
}

package "Controllers" {
  abstract class Controller {
    +handle(requestDto: RequestDto): Response
  }
  class UserController
  class MediaController
  class RatingController
  class LeaderboardController
}

package "Services" {
  class AuthService
  class UserService
  class MediaService
  class RatingService
  class FavoritesService
  class RecommendationService
  class LeaderboardService
}

package "Repositories" {
  interface UserRepository
  interface MediaRepository
  interface RatingRepository

  class DbUserRepository
  class DbMediaRepository
  class DbRatingRepository
}

package "Request DTO" {
  class RequestDto
}

' ===== Flow =====
Server --> Handler
Handler --> MrpApplication : handle(Request)
Handler ..> Request : builds/parses

MrpApplication ..> RequestDto : request.getRequestDto()
MrpApplication --> AuthMiddleware : authenticate()
MrpApplication --> Router : findController(path)
MrpApplication --> Controller : dispatch(handle)
MrpApplication --> ExceptionMapper : map exceptions

RouterCreator --> Router : configures routes

' ===== Controller -> Service =====
UserController ..> UserService
UserController ..> AuthService
UserController ..> RecommendationService

MediaController ..> MediaService
MediaController ..> RatingService
MediaController ..> FavoritesService

RatingController ..> RatingService
LeaderboardController ..> LeaderboardService

' ===== Service -> Repo =====
UserService ..> UserRepository
MediaService ..> MediaRepository
RatingService ..> RatingRepository

UserRepository <|.. DbUserRepository
MediaRepository <|.. DbMediaRepository
RatingRepository <|.. DbRatingRepository

note left of MrpApplication
MRP request flow:
Request -> RequestDto -> AuthMiddleware -> Router -> Controller
Exceptions -> ExceptionMapper -> Response
end note

@enduml
